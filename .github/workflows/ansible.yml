name: Publish

on:
  push:
    paths:
      - '.github/workflows/ansible.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  ansible:
    runs-on: ubuntu-latest
    steps:
      - uses: step-security/harden-runner@v1
        with:
          egress-policy: audit # TODO: change to 'egress-policy: block' after couple of runs
      - run: curl https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
      - run: echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
      - run: sudo add-apt-repository --yes --update ppa:ansible/ansible
      - run: sudo apt update
      - uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: ansible cloudflare-warp

      - name: Create XML file
        run: |
          sudo mkdir -p /var/lib/cloudflare-warp
          sudo bash -c 'cat <<EOL > /var/lib/cloudflare-warp/mdm.xml
          <?xml version="1.0" encoding="UTF-8"?>
          <dict>
            <key>organization</key>
            <string>${{ vars.CF_ZT_ST_ORG }}</string>
            <key>auth_client_id</key>
            <string>${{ vars.CF_ZT_ST_ID }}</string>
            <key>auth_client_secret</key>
            <string>${{ secrets.CF_ZT_ST_SECRET }}</string>
          </dict>
          EOL'
      - run: sudo systemctl start warp-svc.sevice
      - run: warp-cli register
      - run: warp-cli connect
      - run: warp-cli account

      - name: Start SSH agent
        run: ssh-agent -a ${{ runner.temp }}/ssh_agent.sock
      - name: Add SSH keys
        run: |
          echo "${{ secrets.PK_NAS2 }}" | ssh-add -t 15m -
        env:
          SSH_AUTH_SOCK: ${{ runner.temp }}/ssh_agent.sock

      - uses: actions/checkout@v3
      # - run: ansible-playbook -i hosts.yml playbooks/initial.yaml
      #   env:
      #     SSH_AUTH_SOCK: ${{ runner.temp }}/ssh_agent.sock

      - run: sudo rm -rfv /var/lib/cloudflare-warp/mdm.xml
        if: ${{ always() }}